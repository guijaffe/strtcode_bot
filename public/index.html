<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Управление заказами</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .nav-item {
	        cursor: pointer;
        }
	</style>
</head>
<body>
<div class="container mt-4">
	<h1 class="text-center">Управление заказами</h1>
	<ul class="nav nav-tabs">
		<li class="nav-item">
			<a class="nav-link active" data-tab="orders">Заказы</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" data-tab="users">Пользователи</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" data-tab="admin-messages">Сообщения администратору</a>
		</li>
	</ul>
	<div id="orders" class="tab-content active">
		<h2 class="mt-3">Заказы</h2>
		<table class="table table-striped table-bordered">
			<thead>
			<tr>
				<th>Данные о пользователе</th>
				<th>Категория</th>
				<th>Цена (юани)</th>
				<th>Итоговая цена (руб)</th>
				<th>Ссылка на товар</th>
				<th>Размер</th>
				<th>Артикул</th>
				<th>Время</th>
				<th>Статус</th>
				<th>Заметка</th>
				<th>Действия</th>
			</tr>
			</thead>
			<tbody id="ordersTableBody">
			<!-- Заказы будут загружены сюда -->
			</tbody>
		</table>
	</div>
	<div id="users" class="tab-content">
		<h2 class="mt-3">Пользователи</h2>
		<table class="table table-striped table-bordered">
			<thead>
			<tr>
				<th>ID</th>
				<th>Юзернейм</th>
				<th>Имя</th>
				<th>Фамилия</th>
				<th>Время</th>
			</tr>
			</thead>
			<tbody id="usersTableBody">
			<!-- Данные о пользователях будут загружены сюда -->
			</tbody>
		</table>
	</div>
	<div id="admin-messages" class="tab-content">
		<h2 class="mt-3">Сообщения администратору</h2>
		<table class="table table-striped table-bordered">
			<thead>
			<tr>
				<th>ID</th>
				<th>Юзернейм</th>
				<th>Имя</th>
				<th>Фамилия</th>
				<th>Сообщение</th>
				<th>Время</th>
			</tr>
			</thead>
			<tbody id="adminMessagesTableBody">
			<!-- Сообщения администратору будут загружены сюда -->
			</tbody>
		</table>
	</div>
</div>
<script>
	// Функция для загрузки заказов
	async function loadOrders() {
		try {
			const response = await fetch("/orders");
			if (!response.ok) {
				throw new Error("Ошибка при загрузке заказов");
			}
			const orders = await response.json();

			const tbody = document.querySelector("#ordersTableBody");
			tbody.innerHTML = "";

			orders.forEach(order => {
				const row = document.createElement("tr");
				row.innerHTML = `
                    <td class="user-data">
                        <div><strong>ID:</strong> ${order.userId}</div>
                        ${order.username ? `<div><strong>Юзернейм:</strong> @${order.username}</div>` : ''}
                        ${order.firstName ? `<div><strong>Имя:</strong> ${order.firstName}</div>` : ''}
                        ${order.lastName ? `<div><strong>Фамилия:</strong> ${order.lastName}</div>` : ''}
                        <div><strong>Ссылка:</strong> <a href="tg://user?id=${order.userId}">Написать</a></div>
                    </td>
                    <td>${order.category}</td>
                    <td>${order.price}</td>
                    <td>${order.finalPrice}</td>
                    <td><a href="${order.productLink}" target="_blank">Ссылка</a></td>
                    <td>${order.size}</td>
                    <td>${order.article}</td>
                    <td>${order.timestamp}</td>
                    <td>
                        <select onchange="updateStatus('${order.userId}', this.value)">
                            <option value="new" ${order.status === 'new' ? 'selected' : ''}>Новый</option>
                            <option value="in_progress" ${order.status === 'in_progress' ? 'selected' : ''}>В процессе</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Завершен</option>
                        </select>
                    </td>
                    <td>
                        <textarea class="note">${order.note || ''}</textarea>
                        <button onclick="saveNote('${order.userId}', this.previousElementSibling.value)">Сохранить</button>
                    </td>
                    <td>
                        <button class="delete" onclick="deleteOrder('${order.userId}')">Удалить</button>
                    </td>
                `;
				tbody.appendChild(row);
			});
		} catch (error) {
			console.error("Ошибка при загрузке заказов:", error);
			alert("Ошибка при загрузке заказов. Проверьте консоль для подробностей.");
		}
	}

	// Функция для загрузки пользователей
	async function loadUsers() {
		try {
			const response = await fetch("/users");
			if (!response.ok) {
				throw new Error("Ошибка при загрузке пользователей");
			}
			const users = await response.json();

			const tbody = document.querySelector("#usersTableBody");
			tbody.innerHTML = "";

			users.forEach(user => {
				const row = document.createElement("tr");
				row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.username}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastName}</td>
                    <td>${user.timestamp}</td>
                `;
				tbody.appendChild(row);
			});
		} catch (error) {
			console.error("Ошибка при загрузке пользователей:", error);
			alert("Ошибка при загрузке пользователей. Проверьте консоль для подробностей.");
		}
	}

	// Функция для загрузки сообщений администратору
	async function loadAdminMessages() {
		try {
			const response = await fetch("/admin-messages");
			if (!response.ok) {
				throw new Error("Ошибка при загрузке сообщений администратору");
			}
			const messages = await response.json();

			const tbody = document.querySelector("#adminMessagesTableBody");
			tbody.innerHTML = "";

			messages.forEach(message => {
				const row = document.createElement("tr");
				row.innerHTML = `
                    <td>${message.userId}</td>
                    <td>${message.username}</td>
                    <td>${message.firstName}</td>
                    <td>${message.lastName}</td>
                    <td>${message.message}</td>
                    <td>${message.timestamp}</td>
                `;
				tbody.appendChild(row);
			});
		} catch (error) {
			console.error("Ошибка при загрузке сообщений администратору:", error);
			alert("Ошибка при загрузке сообщений администратору. Проверьте консоль для подробностей.");
		}
	}

	// Обработка переключения вкладок
	document.querySelectorAll(".nav-link").forEach(tab => {
		tab.addEventListener("click", () => {
			document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
			document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
			tab.classList.add("active");
			document.getElementById(tab.getAttribute("data-tab")).classList.add("active");

			// Загрузка данных при переключении вкладок
			if (tab.getAttribute("data-tab") === "orders") {
				loadOrders();
			} else if (tab.getAttribute("data-tab") === "users") {
				loadUsers();
			} else if (tab.getAttribute("data-tab") === "admin-messages") {
				loadAdminMessages();
			}
		});
	});

	// Загружаем заказы при загрузке страницы
	document.addEventListener("DOMContentLoaded", () => {
		loadOrders();
	});
</script>
</body>
</html>